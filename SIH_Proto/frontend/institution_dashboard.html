<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institution Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f4f7f8; font-family: sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab.active { border-bottom: 2px solid #059669; color: #059669; }
    </style>
</head>
<body>
<nav class="bg-white shadow p-4 flex justify-between items-center">
    <div>
        <h1 class="text-xl font-bold text-gray-800" id="institutionName">Institution Portal</h1>
    </div>
    <div>
        <span id="userName" class="text-gray-600 mr-4"></span>
        <a href="#" onclick="logout()" class="text-red-500 hover:text-red-700">Logout</a>
    </div>
</nav>

<main class="container mx-auto p-6">
    <section id="stats-overview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></section>

    <div class="bg-white p-6 rounded-lg shadow">
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="switchTab('single-upload')" class="tab active px-3 py-2 font-medium text-sm rounded-t-lg">Single Upload</button>
                <button onclick="switchTab('bulk-upload')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">Bulk Upload</button>
                <button onclick="switchTab('view-certs')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">View Certificates</button>
                <button onclick="switchTab('history')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">Upload History</button>
            </nav>
        </div>

        <div id="single-upload" class="tab-content active">
            <h3 class="text-lg font-semibold mb-4">Add Single Certificate</h3>
            <form id="singleUploadForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="certificate_id" placeholder="Certificate ID *" required class="border p-2 rounded w-full">
                    <input type="text" name="name" placeholder="Student Name *" required class="border p-2 rounded w-full">
                    <input type="text" name="roll_no" placeholder="Roll No *" required class="border p-2 rounded w-full">
                    <input type="number" name="marks" placeholder="Marks (0-10) *" required class="border p-2 rounded w-full">
                    <input type="text" name="course" placeholder="Course (e.g., Computer Science)" class="border p-2 rounded w-full">
                    <input type="text" name="graduation_date" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Graduation Date (YYYY-MM-DD)" class="border p-2 rounded w-full">
                </div>
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Add Certificate</button>
            </form>
        </div>

        <div id="bulk-upload" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Bulk Upload Certificates</h3>
            <p class="text-sm text-gray-600 mb-4">Upload a CSV file with certificate data. <a href="#" id="downloadTemplateBtn" class="text-emerald-600 hover:underline">Download Template</a>.</p>
            <form id="bulkUploadForm">
                <input type="file" id="bulkFile" name="file" accept=".csv" required class="border p-2 rounded w-full md:w-1/2">
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 mt-2">Upload File</button>
            </form>
            <div id="bulk-upload-result" class="mt-4"></div>
        </div>

        <div id="view-certs" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Manage Certificates</h3>
            <div class="mb-4">
                <input type="text" id="cert-search" placeholder="Search by name, cert ID, or roll no..." class="border p-2 rounded w-full md:w-1/3">
            </div>
            <div id="certificates-list" class="overflow-x-auto"></div>
        </div>

        <div id="history" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Bulk Upload History</h3>
            <div id="upload-history-list" class="space-y-3"></div>
        </div>
    </div>
</main>

<script>
    const API_BASE_URL = 'http://localhost:5000/api';

    async function apiCall(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        if (!token) {
            logout();
            return;
        }

        const options = {
            method,
            headers: { 'Authorization': `Bearer ${token}` }
        };
        if (body) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, options);

        if (response.status === 401) {
            logout(); // backend says token invalid
            return;
        }

        return response.json();
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        sessionStorage.removeItem('token');
        sessionStorage.removeItem('user');
        window.location.href = 'login.html';
    }
    async function loadUser() {
        const userData = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (!userData) {
            logout();
            return;
        }

        const user = JSON.parse(userData);
        document.getElementById('userName').textContent = `User: ${user.username}`;
    }

    async function loadCertificates() {
        const list = document.getElementById('certificates-list');
        list.innerHTML = `<p>Loading certificates...</p>`;
        try {
            const data = await apiCall('/certificates');
            list.innerHTML = '';
            data.forEach(cert => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded shadow mb-3';
                div.innerHTML = `
                    <p><strong>ID:</strong> ${cert.certificate_id}</p>
                    <p><strong>Name:</strong> ${cert.recipient_name}</p>
                    <p><strong>Course:</strong> ${cert.course}</p>
                    <p><strong>Status:</strong> ${cert.status}</p>
                    <button onclick="verifyCertificate('${cert.certificate_id}')" 
                            class="mt-2 px-3 py-1 bg-green-500 text-white rounded">Verify</button>
                `;
                list.appendChild(div);
            });
        } catch (err) {
            list.innerHTML = `<p class="text-red-500">Error loading certificates</p>`;
        }
    }

    async function verifyCertificate(certId) {
        const result = await apiCall(`/certificates/verify/${certId}`);
        alert(`Certificate ${certId}: ${result.status}`);
        loadCertificates();
    }

    async function loadUploadHistory() {
        const history = document.getElementById('upload-history-list');
        history.innerHTML = `<p>Loading uploads...</p>`;
        try {
            const data = await apiCall('/uploads');
            history.innerHTML = '';
            data.forEach(upload => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded shadow';
                div.innerHTML = `
                    <p><strong>File:</strong> ${upload.filename}</p>
                    <p><strong>Status:</strong> ${upload.status}</p>
                    <p><strong>Date:</strong> ${upload.uploaded_at}</p>
                `;
                history.appendChild(div);
            });
        } catch (err) {
            history.innerHTML = `<p class="text-red-500">Error loading uploads</p>`;
        }
    }

    async function uploadBulkCertificates(event) {
        event.preventDefault();
        const fileInput = document.getElementById('bulkFile');
        if (!fileInput.files.length) {
            alert('Please select a file');
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const token = localStorage.getItem('token');
        const response = await fetch(`${API_BASE_URL}/certificates/bulk_upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        const data = await response.json();
        alert(data.message || 'Upload complete');
        loadUploadHistory();
    }

    async function downloadTemplate() {
        const data = await apiCall('/certificates/template');
        if (data.template_url) {
            window.location.href = `http://localhost:5000${data.template_url}`;
        } else {
            alert('Error downloading template');
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // Event listeners
    document.getElementById('bulkUploadForm')?.addEventListener('submit', uploadBulkCertificates);
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', (e) => {
        e.preventDefault();
        downloadTemplate();
    });

    // Initialize
    loadUser();
    loadCertificates();
    loadUploadHistory();
</script>
</body>
</html>
