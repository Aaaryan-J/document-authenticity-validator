<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institution Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f4f7f8; font-family: sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab.active { border-bottom: 2px solid #059669; color: #059669; }
    </style>
</head>
<body>
<nav class="bg-white shadow p-4 flex justify-between items-center">
    <div>
        <h1 class="text-xl font-bold text-gray-800" id="institutionName">Institution Portal</h1>
    </div>
    <div>
        <span id="userName" class="text-gray-600 mr-4"></span>
        <a href="#" onclick="logout()" class="text-red-500 hover:text-red-700">Logout</a>
    </div>
</nav>

<main class="container mx-auto p-6">
    <section id="stats-overview" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        </section>

    <div class="bg-white p-6 rounded-lg shadow">
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="switchTab('single-upload')" class="tab active px-3 py-2 font-medium text-sm rounded-t-lg">Single Upload</button>
                <button onclick="switchTab('bulk-upload')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">Bulk Upload</button>
                <button onclick="switchTab('view-certs')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">View Certificates</button>
                <button onclick="switchTab('history')" class="tab px-3 py-2 font-medium text-sm rounded-t-lg">Upload History</button>
            </nav>
        </div>

        <div id="single-upload" class="tab-content active">
            <h3 class="text-lg font-semibold mb-4">Add Single Certificate</h3>
            <form id="singleUploadForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" name="certificate_id" placeholder="Certificate ID *" required class="border p-2 rounded w-full">
                    <input type="text" name="name" placeholder="Student Name *" required class="border p-2 rounded w-full">
                    <input type="text" name="roll_no" placeholder="Roll No *" required class="border p-2 rounded w-full">
                    <input type="number" name="marks" placeholder="Marks (0-100) *" required class="border p-2 rounded w-full">
                    <input type="text" name="course" placeholder="Course (e.g., Computer Science)" class="border p-2 rounded w-full">
                    <input type="text" name="graduation_date" onfocus="(this.type='date')" onblur="(this.type='text')" placeholder="Graduation Date (YYYY-MM-DD)" class="border p-2 rounded w-full">
                </div>
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700">Add Certificate</button>
            </form>
        </div>

        <div id="bulk-upload" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Bulk Upload Certificates</h3>
            <p class="text-sm text-gray-600 mb-4">Upload a CSV or Excel file with certificate data. <a href="#" id="downloadTemplateBtn" class="text-emerald-600 hover:underline">Download Template</a>.</p>
            <form id="bulkUploadForm">
                <input type="file" name="file" accept=".csv, .xlsx, .xls" required class="border p-2 rounded w-full md:w-1/2">
                <button type="submit" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 mt-2">Upload File</button>
            </form>
            <div id="bulk-upload-result" class="mt-4"></div>
        </div>

        <div id="view-certs" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Manage Certificates</h3>
            <div class="mb-4">
                <input type="text" id="cert-search" placeholder="Search by name, cert ID, or roll no..." class="border p-2 rounded w-full md:w-1/3">
            </div>
            <div id="certificates-list" class="overflow-x-auto"></div>
        </div>

        <div id="history" class="tab-content">
            <h3 class="text-lg font-semibold mb-4">Bulk Upload History</h3>
            <div id="upload-history-list" class="space-y-3"></div>
        </div>
    </div>
</main>

<script>
const API_BASE_URL = 'http://localhost:5000/api';
let user = null;

// --- Authentication and Initial Load ---
window.addEventListener('load', function() {
    const token = localStorage.getItem('authToken');
    const userData = localStorage.getItem('userData');
    
    if (!token || !userData) {
        window.location.href = 'login.html';
        return;
    }
    
    user = JSON.parse(userData);
    if (user.role !== 'institution') {
        alert('Institution access required');
        window.location.href = 'login.html';
        return;
    }

    document.getElementById('userName').textContent = User: ${user.username};
    loadDashboardData();
});

async function apiCall(endpoint, method = 'GET', data = null, isFormData = false) {
    const token = localStorage.getItem('authToken');
    const options = {
        method: method,
        headers: { 'Authorization': Bearer ${token} }
    };
    
    if (data) {
        if (isFormData) {
            options.body = data;
        } else {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(data);
        }
    }
    
    const response = await fetch(${API_BASE_URL}${endpoint}, options);
    if (response.status === 401) logout();
    return response;
}

// --- Tab Switching Logic ---
function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    event.target.classList.add('active');

    if (tabId === 'view-certs') loadCertificates();
    if (tabId === 'history') loadUploadHistory();
}

// --- Data Loading Functions ---
async function loadDashboardData() {
    const response = await apiCall('/institution/dashboard');
    if (!response.ok) return alert('Failed to load dashboard data.');

    const data = await response.json();
    document.getElementById('institutionName').textContent = data.institution.name;
    const statsContainer = document.getElementById('stats-overview');
    const stats = data.statistics;
    statsContainer.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow"><p class="text-2xl font-bold">${stats.total_certificates}</p><p class="text-gray-600">Total Certificates</p></div>
        <div class="bg-white p-4 rounded-lg shadow"><p class="text-2xl font-bold">${stats.total_bulk_uploads}</p><p class="text-gray-600">Bulk Uploads</p></div>
        <div class="bg-white p-4 rounded-lg shadow"><p class="text-2xl font-bold">${stats.successful_uploads}</p><p class="text-gray-600">Successful Uploads</p></div>
        <div class="bg-white p-4 rounded-lg shadow"><p class="text-2xl font-bold">${stats.success_rate}%</p><p class="text-gray-600">Success Rate</p></div>
    `;
}

async function loadCertificates(page = 1, search = '') {
    const list = document.getElementById('certificates-list');
    list.innerHTML = <p>Loading certificates...</p>;
    const response = await apiCall(/institution/certificates?page=${page}&search=${search});
    if (!response.ok) return list.innerHTML = <p class="text-red-500">Failed to load certificates.</p>;

    const data = await response.json();
    if (data.certificates.length === 0) {
        return list.innerHTML = <p>No certificates found.</p>;
    }

    let tableHTML = `<table class="min-w-full bg-white">
        <thead class="bg-gray-100"><tr>
            <th class="py-2 px-4 text-left">Cert ID</th><th class="py-2 px-4 text-left">Name</th>
            <th class="py-2 px-4 text-left">Roll No</th><th class="py-2 px-4 text-left">Marks</th>
        </tr></thead><tbody>`;

    data.certificates.forEach(cert => {
        tableHTML += `<tr>
            <td class="border-t py-2 px-4">${cert.certificate_id}</td><td class="border-t py-2 px-4">${cert.name}</td>
            <td class="border-t py-2 px-4">${cert.roll_no}</td><td class="border-t py-2 px-4">${cert.marks}</td>
        </tr>`;
    });
    tableHTML += </tbody></table>;
    list.innerHTML = tableHTML;
}

async function loadUploadHistory() {
    const list = document.getElementById('upload-history-list');
    list.innerHTML = <p>Loading history...</p>;
    const response = await apiCall('/institution/uploads/history');
    if (!response.ok) return list.innerHTML = <p class="text-red-500">Failed to load history.</p>;

    const data = await response.json();
    if(data.bulk_uploads.length === 0) return list.innerHTML = <p>No bulk uploads found.</p>;

    list.innerHTML = '';
    data.bulk_uploads.forEach(upload => {
        const statusColor = upload.status === 'completed' ? 'green' : (upload.status === 'failed' ? 'red' : 'yellow');
        const errorDetails = upload.errors && upload.errors.length > 0 ? `<details class="mt-2 text-sm"><summary>View Errors</summary><ul class="list-disc pl-5 text-red-600">
            ${upload.errors.slice(0, 5).map(e => <li>${e}</li>).join('')}
            ${upload.errors.length > 5 ? '<li>...and more</li>' : ''}
            </ul></details>` : '';
            
        list.innerHTML += `<div class="border p-3 rounded bg-gray-50">
            <p><strong>File:</strong> ${upload.filename} | <strong>Status:</strong> <span class="font-semibold text-${statusColor}-600">${upload.status}</span></p>
            <p class="text-sm text-gray-600">Processed: ${upload.total_records}, Successful: ${upload.successful_records}, Failed: ${upload.failed_records}</p>
            ${errorDetails}
            </div>`;
    });
}

// --- Form Submissions ---
document.getElementById('singleUploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    
    // Convert empty strings for optional fields to null
    if (data.graduation_date === '') delete data.graduation_date;
    if (data.course === '') delete data.course;

    const response = await apiCall('/institution/upload/single', 'POST', data);
    const result = await response.json();

    if (response.ok) {
        alert('Certificate added successfully!');
        e.target.reset();
        loadDashboardData();
    } else {
        alert(Error: ${result.error});
    }
});

document.getElementById('bulkUploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(e.target);
    const resultDiv = document.getElementById('bulk-upload-result');
    resultDiv.innerHTML = <p>Uploading and processing... This may take a moment.</p>;

    const response = await apiCall('/institution/upload/bulk', 'POST', formData, true);
    const result = await response.json();
    
    if (response.ok) {
        resultDiv.innerHTML = `<div class="p-4 bg-green-100 text-green-800 rounded">
            <h4 class="font-bold">Upload Complete!</h4>
            <p>Processed: ${result.results.total_processed}</p>
            <p>Successful: ${result.results.successful}</p>
            <p>Failed: ${result.results.failed}</p>
            </div>`;
        e.target.reset();
        loadDashboardData();
    } else {
        resultDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded">
            <h4 class="font-bold">Upload Failed</h4>
            <p>${result.error}</p>
            </div>`;
    }
});

document.getElementById('downloadTemplateBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    const response = await apiCall('/institution/template');
    if (!response.ok) return alert('Failed to generate template.');
    const data = await response.json();
    // The backend now provides a direct download link which we added in api_main.py
    window.location.href = http://localhost:5000${data.template_url};
});

document.getElementById('cert-search').addEventListener('input', (e) => {
    loadCertificates(1, e.target.value);
});


function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    window.location.href = 'login.html';
}
</script>
</body>
</html>